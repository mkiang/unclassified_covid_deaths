---
title: "Table S1. Assessing model fairness with respect to race, ethnicity, sex, and education"
author: "Mathew Kiang"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: true
    toc_float: true
    code_folding: hide
    mode: selfcontained
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(error = FALSE)
```

```{r preamble}
## Imports ----
library(tidyverse)
library(here)
library(knitr)
library(kableExtra)
library(DT)
library(fairness)
source(here("code", "utils.R"))

## Data ----
fair_df <- readRDS(here("data", "fairness_metrics.RDS")) |>
    filter(grouping %in% c("racerbig_cat", "is_nonhispanic_cat", "sex_cat", "educ_cat")) |>
    filter(metric_name %in% c("ROC AUC", "FPR", "FNR"))
```

We will assess the model fairness with respect to race by comparing (1) ROC AUC, (2) false negative rate parity, and (3) false positive rate parity. Taken together, these metrics represent the most important factors associated with the target task of the paper: creating a classifier on in-hospital deaths that can be used for out-of-hospital prediction. For all metrics, we use the largest subgroup as our reference group.

```{r}
fairness_table <- fair_df |>
    mutate(
        group_name = case_when(
            grouping == "educ_cat" &
                group_name == "unknown" ~ "unknown_education",
            TRUE ~ group_name
        )
    ) |>
    transmute(
        group_name,
        group_size = prettyNum(group_size, big.mark = ","),
        parity_name,
        parity_print = sprintf("%0.2f (%0.3f)", round(parity_value, 2), round(metric_value, 3))
    ) |>
    pivot_wider(names_from = "parity_name",
                values_from = c("parity_print")) |>
    mutate(
        raceeth_cat = factor(
            group_name,
            levels = c(
                "aian",
                "asian",
                "asian_indian",
                "black",
                "multiracial",
                "pacific_islander",
                "white",
                
                "hispanic",
                "nonhispanic",
                "unknown",
                
                "F",
                "M",
                
                "< hs",
                "hs_no_diploma",
                "hs_ged",
                "some_college",
                "associate",
                "bachelor",
                "master",
                "doctorate",
                "unknown_education"
            ),
            labels = c(
                "American Indian / Alaska Native",
                "Asian",
                "Asian Indian",
                "Black",
                "Multiracial / other",
                "Pacific Islander",
                "White (referent)",
                
                "Hispanic",
                "Non-Hispanic (referent)",
                "Unknown ethnicity",
                
                "Female",
                "Male (referent)",
                
                "Less than high school",
                "Some high school, no diploma",
                "High school graduate / GED (referent)",
                "Some college, no degree",
                "Associate degree",
                "Bachelor's degree",
                "Master's degree",
                "Doctoral or professional degree",
                "Unknown education"
            ),
            ordered = TRUE
        ),
        .before = 1
    ) |>
    select(-group_name) |>
    arrange(raceeth_cat)
```

```{r}
fairness_table |>
    kable(
        format = "html", 
        row.names = NA,
        col.names = c(
            "Individual-level characteristics",
            "Deaths (N)",
            "ROC AUC Parity\n(ROC AUC)",
            "False Negative Rate\nParity (False Negative Rate)",
            "False Positive Rate\nParity (False Positive Rate)"
        )
    ) |> 
    kable_styling("striped", full_width = TRUE)
```


