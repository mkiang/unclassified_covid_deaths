---
title: "Table S3. Assessing model fairness with respect to state"
author: "Mathew Kiang"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: true
    toc_float: true
    code_folding: hide
    mode: selfcontained
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(error = FALSE)
```

```{r preamble}
## Imports ----
library(tidyverse)
library(here)
library(knitr)
library(kableExtra)
library(DT)
library(fairness)
source(here("code", "utils.R"))

## Data ----
fair_df <- readRDS(here("data", "fairness_metrics.RDS")) |>
    filter(grouping %in% c("state_cat")) |>
    filter(metric_name %in% c("ROC AUC", "FPR", "FNR"))
```

We will assess the model fairness with respect to race by comparing (1) ROC AUC, (2) false negative rate parity, and (3) false positive rate parity. Taken together, these metrics represent the most important factors associated with the target task of the paper: creating a classifier on in-hospital deaths that can be used for out-of-hospital prediction. For all metrics, we use the largest subgroup as our reference group.

```{r}
fairness_table <- fair_df |>
    transmute(
        group_name,
        group_size = prettyNum(group_size, big.mark = ","),
        parity_name,
        parity_print = sprintf("%0.2f (%0.3f)", round(parity_value, 2), round(metric_value, 3))
    ) |>
    pivot_wider(names_from = "parity_name",
                values_from = c("parity_print")) |>
    arrange(group_name)
```

```{r}
fairness_table |>
    kable(
        format = "html", 
        row.names = NA,
        col.names = c(
            "Race / ethnicity",
            "Deaths (N)",
            "ROC AUC Parity\n(ROC AUC)",
            "False Negative Rate\nParity (False Negative Rate)",
            "False Positive Rate\nParity (False Positive Rate)"
        )
    ) |> 
    kable_styling("striped", full_width = TRUE)
```


